


# Skip to content
# Using Gmail with screen readers
# Conversations
# 32.97 GB of 100 GB used
# Terms · Privacy · Program Policies
# Last account activity: 0 minutes ago
# Open in 1 other location · Details



import rclpy
from rclpy.node import Node
import math
from geometry_msgs.msg import Twist 
from nav_msgs.msg import Odometry

import numpy as np
import matplotlib.pyplot as plt
import sys
import pathlib
import bisect
sys.path.append(str(pathlib.Path(__file__).parent.parent.parent))

class State(object):
    """
    Class representing the state of a vehicle.

    :param x: (float) x-coordinate
    :param y: (float) y-coordinate
    :param yaw: (float) yaw angle
    :param v: (float) speed
    """

    def __init__(self, x=0.0, y=0.0, yaw=0.0, v=0.0):
        """Instantiate the object."""
        super(State, self).__init__()
        self.x = x #current latitude
        self.y = y #current longitude
        self.yaw = yaw # current yaw
        self.v = v #current velocity

    def update(self, acceleration, delta):
        """
        Update the state of the vehicle.

        Stanley Control uses bicycle model.

        :param acceleration: (float) Acceleration
        :param delta: (float) Steering
        """
        delta = np.clip(delta, -max_steer, max_steer)

        self.x += self.v * np.cos(self.yaw) * dt
        self.y += self.v * np.sin(self.yaw) * dt
        self.yaw += self.v / L * np.tan(delta) * dt
        self.yaw = normalize_angle(self.yaw)
        self.v += acceleration * dt

#reference data for the spline path--(in meters)-----------------------------------------------------------------------------------------

def reference_data():
    cx=[]
    cy=[]
    cyaw=[]

    cx = [0.0, 0.036639286807564925, 0.07470447677625604, 0.11562147306719951, 0.16081617884152152, 0.21171449726034827, 0.269742331484806, 0.3363255846760208, 0.4128901599951188, 0.5008619606032264, 0.6014561648604219, 0.7093253764960965, 0.8114356186260162, 0.8943156256106006, 0.9444941318102695, 0.9484998715854425, 0.8928615792965391, 0.7902916892953615, 0.7492712671449958, 0.767528825252002, 0.786303903166421, 0.7489284114798492, 0.646801915067171, 0.5175951649982408, 0.38915071471328944, 0.26893532513012347, 0.16237682474353562, 0.07490304204832042, 0.011941805539271919, -0.021630034345565152, -0.026000975924896207, -0.004086592388460758, 0.04117120251550366, 0.10683049503875935, 0.1899493714330687, 0.28758591795019384, 0.3967982208418976, 0.5146443663599423, 0.6381824407560903, 0.7644705302821035, 0.8905667211897446, 1.0135290997307767, 1.1304190847956328, 1.239413882920134, 1.3414196493830146, 1.4377519999266772, 1.5297265502935278, 1.6186589162259695, 1.7058647134664078, 1.7926595577572464, 1.88035906484089, 1.9702788504597437, 2.0635991120826946, 2.159954477460565, 2.257995878466142, 2.3563584456820776, 2.453677490216508, 2.5489145818449397, 2.642031428362579, 2.733180735321271, 2.8225152082728635, 2.910187552769204, 2.9963504743621376, 3.0811566786035125, 3.1647610648282907, 3.24734732035268, 3.3291193945956823, 3.4102816593764986, 3.491038486514332, 3.5715942478283824, 3.652153315137854, 3.732920060261948, 3.814098855019865, 3.8958940522357874, 3.978450670500932, 4.0617230751737905, 4.145627414564736, 4.230079836984132, 4.314996490742352, 4.400293524149764, 4.485887085516738, 4.571693323153643, 4.657628385370851, 4.743608420478727, 4.829546681088395, 4.915311067069273, 5.0007335003692885, 5.0856449137745905, 5.1698762400713205, 5.253258412045631, 5.335622362483665, 5.416799024171572, 5.4966193298955, 5.574914212441592, 5.651514604595997, 5.726251439144861, 5.798955648874336, 5.869458166570561, 5.9375899250196875, 6.0031818570078626, 6.066064895321231, 6.126072034639674, 6.183349828122463, 6.238691727968399, 6.292971092060079, 6.347061278280103, 6.401835644511068, 6.458167548635569, 6.5169303485362065, 6.578997402095578, 6.645242067196281, 6.716457721397864, 6.7925109827018115, 6.872671986687921, 6.956200991476415, 7.04235825518751, 7.130404035941432, 7.219598591858392, 7.309202181058614, 7.39847506166232, 7.4866774917897265, 7.573070726514996, 7.657182372413369, 7.73916389377096, 7.819255952255234, 7.897699209533657, 7.974734327273699, 8.05060196714282, 8.12554279080849, 8.199797459938175, 8.27360663619934, 8.347210981259453, 8.420851156785977, 8.49476782444638, 8.569201645908127, 8.644393282838687, 8.720583396905527, 8.798012649776105, 8.876921703117896, 8.957509932247849, 9.039692483613027, 9.123264854592, 9.208022125582776, 9.293759376983363, 9.38027168919177, 9.467354142606009, 9.554801817624083, 9.642409794644008, 9.729973154063787, 9.817286976281428, 9.904146341694945, 9.990346330702343, 10.075682023701631, 10.159948501090819, 10.242940843267915, 10.324454130630928, 10.404367783629091, 10.483080923253409, 10.56119044876904, 10.639293645265177, 10.717987797831006, 10.797870191555724, 10.879538111528518, 10.963588842838583, 11.050619670575106, 11.14121775863802, 11.235168445743057, 11.330887209963045, 11.426655482767927, 11.520913211781213, 11.61333974517626, 11.704197648602085, 11.793752887699977, 11.882271428111242, 11.970019235477178, 12.057262275439076, 12.144266513638243, 12.231297915715974, 12.318622447313567, 12.406506074072322, 12.495214761633532, 12.585014475638506, 12.676171181728533, 12.768950845544916, 12.863563672894507, 12.959890928180885, 13.057693672699358, 13.156732789988757, 13.25676916358793, 13.357563677035698, 13.458877213870899, 13.560470657632376, 13.662104891858961, 13.763540800089483, 13.86453926586279, 13.964861172717704, 14.064267404193075, 14.162518353536464, 14.25936252125906, 14.354536162478327, 14.447774971470102, 14.538814642510225, 14.627390869874535, 14.713313015509431, 14.798055095943909, 14.884739446583165, 14.976558803262096, 15.076705901815584, 15.188373478078516, 15.314754267885782, 15.457178922084326, 15.604680664402009, 15.741306066303373, 15.851087468642794, 15.918057212274665, 15.926247638053365, 15.860726943601723, 15.759718495251889, 15.699614367400326, 15.683833681923582, 15.706501253169503, 15.761741895485931, 15.843680423220711, 15.94644165072168, 16.06415039233669, 16.190931462413573, 16.320909675300182, 16.448209845344362, 16.568047560751896, 16.68003990498072, 16.784914019595465, 16.883397046188165, 16.976216126350867, 17.06409840167561, 17.147771013754443, 17.227961104179403, 17.30539581454254, 17.380802286435895, 17.45490766145151, 17.528439081181425, 17.602102150030305, 17.676240614155276, 17.750897908529538, 17.82610837462612, 17.901906353918054, 17.97832618787835, 18.05540221798004, 18.133168785696146, 18.21166023249969, 18.2909108998637, 18.370955129261198, 18.451827262165207, 18.533561640048752, 18.616192604384853, 18.699753804689767, 18.784238911910204, 18.869580499208507, 18.955705984293637, 19.042542784874538, 19.130018318660188, 19.218060003359536, 19.306595256681547, 19.395551496335177, 19.484856140029386, 19.57443660547314, 19.66422031037539, 19.7541346724451, 19.844107109391235, 19.934065038922746, 20.023935878748595, 20.113647046577743, 20.203125960119156, 20.292300037081784, 20.381096695174588, 20.469443352106538, 20.55726742558658, 20.64451818884564, 20.73124331311429, 20.817518149088947, 20.903418048972767, 20.989018364968917, 21.074394449280547, 21.159621654110804, 21.244775331662854, 21.329930834139855, 21.41516351374495, 21.50054872268131, 21.586161813152078, 21.672078137360412, 21.75836695374757, 21.845073122880247, 21.93223540014448, 22.01989254092629, 22.108083300611693, 22.19684643458671, 22.286220698237365, 22.376244846949675, 22.46695763610967, 22.55839782110336, 22.650604157316774, 22.74361540013593, 22.837450523443373, 22.931799701479793, 23.02608209230183, 23.119708764644777, 23.212090787243902, 23.3026392288345, 23.390797996236966, 23.47652451196241, 23.56018315363664, 23.64214946281933, 23.722798981070184, 23.80250724994888, 23.881649811015112, 23.96060220582858, 24.039739975948955, 24.1194386615096, 24.200006175601796, 24.281502006472802, 24.363928613037107, 24.447288454209215, 24.531583988903623, 24.61681767603484, 24.70299197451736, 24.790109343265673, 24.878172241194292, 24.967183127217723, 25.05714446025045, 25.148058699206977, 25.239928303001804, 25.33275573054944, 25.426543440764377, 25.521293892561115, 25.61700954485416, 25.713692856557994, 25.811346286587135, 25.909972115558062, 26.00948903461679, 26.109599153274523, 26.209969963752087, 26.310268958270314, 26.41016362905003, 26.50932146831205, 26.607409968277214, 26.704096621166332, 26.79904891920024, 26.89193435459977, 26.98242041958573, 27.07017460637896, 27.154864407200275, 27.2361574170443, 27.313908111188102, 27.388544175159268, 27.460602827154624, 27.530621285371012, 27.599136768005273, 27.666686493254243, 27.73380767931476, 27.801037544383657, 27.868913306657767, 27.937972184333944, 28.008751395609007, 28.081788158679803, 28.15760161818066, 28.23632350636429, 28.31771323163315, 28.401515148026395, 28.487473609583198, 28.575332970342725, 28.664837584344138, 28.75573180562662, 28.84775998822933, 28.940666486191446, 29.03419565355213, 29.128091844350543, 29.222099412625866, 29.31596271241727, 29.40942609776391, 29.50223392270497, 29.594130541279597, 29.684860419442987, 29.774260167051917, 29.862425266893887, 29.94949632725478, 30.035613956420505, 30.120918762676943, 30.205551354310014, 30.2896523396056, 30.373362326849602, 30.45682192432791, 30.540171740326425, 30.62355238313105, 30.707104461027676, 30.790968582302202, 30.875285355240518, 30.960195388128525, 31.04583928925212, 31.132357522620428, 31.219831020828614, 31.308189671963685, 31.397339767212024, 31.487187597760055, 31.57763945479417, 31.668601629500763, 31.75998041306625, 31.85168209667701, 31.94361297151947, 32.03567932878002, 32.127787459645056, 32.21984365530099, 32.31175420693422, 32.403425405731134, 32.494763542878154, 32.58567527018277, 32.67611459181254, 32.766129547629774, 32.855779276263874, 32.94512291634422, 33.03421960650021, 33.12312848536124, 33.2119086915567, 33.300619363715995, 33.389319640468514, 33.478068660443654, 33.566925562270804, 33.65594948457936, 33.74519956599871, 33.83473494515827, 33.92461476068742, 34.01489815121555, 34.10564425537206, 34.196904269678626, 34.28867863099401, 34.38094779829592, 34.473692182547836, 34.56689219471323, 34.6605282457556, 34.754580746638425, 34.849030108325174, 34.94385674177933, 35.03904105796436, 35.134563467843776, 35.230404382381046, 35.32654421253964, 35.4229559202775, 35.51956357753938, 35.61627154238799, 35.71298411837112, 35.809605609036566, 35.90604031793213, 36.002192548605606, 36.09796660460479, 36.193266789477484, 36.287997406771474, 36.382062760034565, 36.47536755495467, 36.56787376492065, 36.6596595458998, 36.75081712183934, 36.84143871668652, 36.93161655438857, 37.0214428588927, 37.11100985414615, 37.20040976409615, 37.28973481268994, 37.379077223874724, 37.46852922159775, 37.55818302980626, 37.64813087244745, 37.73846497346857, 37.82927755681684, 37.9206608464395, 38.01270706628378, 38.1055084402969, 38.19914254025525, 38.29359076232018, 38.38879571849851, 38.48469991349503, 38.58124585201455, 38.67837603876188, 38.77603297844184, 38.87415917575923, 38.972697135418876, 39.071589362125565, 39.17077836058411, 39.27020663549932, 39.36981669157601, 39.469551033519, 39.56935216603307, 39.66916259382305, 39.768924821593735, 39.86858135404995, 39.968074695896505, 40.067347351838194, 40.16634182657983, 40.26500062482622, 40.363266251282184, 40.46108121065252, 40.55838800764206, 40.655129146955574, 40.751247133297895, 40.84668447137383, 40.94138366588818, 41.035287221545765, 41.1283376430514, 41.22047743510987, 41.311649102425996, 41.40179514970459, 41.490858081650465, 41.57878040296843, 41.66550461836327, 41.75097323253983, 41.835128750202884, 41.91791367605727, 41.99927051480778, 42.07914177115923, 42.157469949816424, 42.23419755548418, 42.309267092867294, 42.38262106667059, 42.454201981598864, 42.52408523764996, 42.592898428934085, 42.66141254958781, 42.73039859402927, 42.800627556676574, 42.87287043194786, 42.947898214261244, 43.026481898034845, 43.10939247768678, 43.19740094763516, 43.291278302298124, 43.39179553609378, 43.49972364344026, 43.61583361875567, 43.740756503876774, 43.871851945418236, 44.00317876753006, 44.12864995618445, 44.242178497353606, 44.33767737700975, 44.40905958112507, 44.4502380956718, 44.45512603982511, 44.42191731305366, 44.364341283489914, 44.29965045816994, 44.24509734412981, 44.2179344484056, 44.23541351663251, 44.30660133835641, 44.412159531361056, 44.52659186860505, 44.62440212304701, 44.68009989717369, 44.68402688390849, 44.676833332232945, 44.70294238247133, 44.76820394534781, 44.86365105631584, 44.98028607332307, 45.109111354317186, 45.241129257245845, 45.367354158115866, 45.48186599873981, 45.58585805554343, 45.68152997715082, 45.771081412186035, 45.85671200927317, 45.940621417036276, 46.02500928409943, 46.11207525908674, 46.204018990622245, 46.30282314622134, 46.40815287986877, 46.51827004524327, 46.63141690914178, 46.74583573836121, 46.8597687996985, 46.97145835995059, 47.07914668591438, 47.18107604438682, 47.275488702164836, 47.360626926045356, 47.43473298282532, 47.49604913930162, 47.54281766227122, 47.57328875038587, 47.58675036958121, 47.58454936878891, 47.5682753]
    cy = [0.0, -0.06545084571373921, -0.13195844911845112, -0.2005795679051084, -0.2723709597646836, -0.34838938238814965, -0.4296915934664791, -0.5173343506906446, -0.6123744117516188, -0.7158685343403745, -0.8287361446823731, -0.9476197733217085, -1.0641525291530538, -1.1696825356050873, -1.2555579161064874, -1.313126794085933, -1.333737292972103, -1.3301256003304542, -1.3919987334912363, -1.5106020478833195, -1.627907226616124, -1.6880697386549242, -1.6849243085319296, -1.6600932741441254, -1.6421216446307207, -1.633420047772302, -1.6337839376108712, -1.6430087681884311, -1.660889993546984, -1.687185028497653, -1.721301578877696, -1.7624590747312134, -1.8098751275642104, -1.8627673488826908, -1.9203533501926597, -1.9818507430001209, -2.0464771388110794, -2.11345014913154, -2.181987385467507, -2.2513064593249847, -2.3206249822099774, -2.389160565628491, -2.4561303567725505, -2.520596047697688, -2.5812391245115744, -2.6366840259683535, -2.6855551908221673, -2.7264770578271587, -2.7580740657374716, -2.778970653307248, -2.787791259290631, -2.783160322441763, -2.7641688835726437, -2.7352334539231697, -2.7041600025152395, -2.6788089438624945, -2.6670393933586993, -2.674362603247811, -2.6990925083199295, -2.738168561583192, -2.788530216045738, -2.847116924715707, -2.9108681406012376, -2.976723316710469, -3.0417594412735633, -3.104858312377022, -3.1661720236006388, -3.22587915013256, -3.284158267160934, -3.3411879498739094, -3.397146773459633, -3.452213313106254, -3.5065661440019196, -3.560383834247569, -3.61382281382493, -3.666968378333702, -3.719891564260003, -3.772663408089946, -3.825354946309648, -3.878037215405224, -3.9307812518627907, -3.9836580921684615, -4.036738772808355, -4.090094330268584, -4.143798188308814, -4.19796116041445, -4.252723721003545, -4.308227159979309, -4.3646127672449495, -4.422021832703681, -4.480595646258707, -4.540475497813244, -4.6018026772704985, -4.6647184745336805, -4.729364179506, -4.795881082090666, -4.864410472190892, -4.935093639709884, -5.008071874550853, -5.08348646661701, -5.161478705811564, -5.242187834897489, -5.325441781767135, -5.410426204037856, -5.496247425393306, -5.582011769517144, -5.66682556009303, -5.749795120804614, -5.830026775335558, -5.906626847369518, -5.97870166059015, -6.045443258739033, -6.107036953401232, -6.164307344749125, -6.218089619264022, -6.269218963427224, -6.318530563720037, -6.366859606623762, -6.415041278619707, -6.463910766189174, -6.514303255813468, -6.567052760485597, -6.622679777843257, -6.680970479000393, -6.741606043176423, -6.8042676495907655, -6.868636477462839, -6.93439370601206, -7.0012205144578505, -7.068798082019626, -7.136807587916805, -7.204930211368811, -7.272847131595056, -7.340239527814961, -7.406788579247944, -7.472175465113426, -7.5360813646308245, -7.598187457019554, -7.658174921499039, -7.715783805581926, -7.771159425550094, -7.824617699745461, -7.876475141063194, -7.927048262398463, -7.976653576646436, -8.025607596702283, -8.07422683546117, -8.12282780581827, -8.171727020668747, -8.221240992907774, -8.271686235430517, -8.323379261132148, -8.37663658290783, -8.431774713652736, -8.489110166262035, -8.548959453630893, -8.611486837303106, -8.675918411147128, -8.741123238070726, -8.805969684488973, -8.869326116816937, -8.930060901469682, -8.987042404862276, -9.03913899340979, -9.085219033527286, -9.124173227015842, -9.156661739179269, -9.186367736418353, -9.217270198455989, -9.252956215201548, -9.293948782215306, -9.339329042081454, -9.388169731790704, -9.43954358833378, -9.4925233487014, -9.546181749884276, -9.599591528873132, -9.65182542265868, -9.701956168231645, -9.749056502582741, -9.792199162702685, -9.830456885582196, -9.862902408211992, -9.888608467582793, -9.90689575848648, -9.91854774166252, -9.924882407744848, -9.927218537830708, -9.926874913017345, -9.925170314402006, -9.923423523081935, -9.922953320154377, -9.925078486716577, -9.93111780386578, -9.94239005269923, -9.960214014314172, -9.985908469807853, -10.020677470718597, -10.06294213424078, -10.108258120394963, -10.152049850658583, -10.189741746509076, -10.216758229423878, -10.228754631339521, -10.226604124677865, -10.216346518263908, -10.204242290253088, -10.196551918800857, -10.199535882062651, -10.219454658193918, -10.261107492176384, -10.319643474152375, -10.386298520719441, -10.452297381294366, -10.508864805293946, -10.547225542134964, -10.559069423850017, -10.559953211802728, -10.582717236039104, -10.627727656209265, -10.69121161786239, -10.76939626654767, -10.858508747814284, -10.954776207211417, -11.054425790288256, -11.153684642593982, -11.248779909677783, -11.335938737088838, -11.412240395292493, -11.478202652794154, -11.535210468089339, -11.584648799694987, -11.627902606128043, -11.66635684590545, -11.701396477544142, -11.734406459561072, -11.766771750473174, -11.799877308797388, -11.835108093050662, -11.873849061749933, -11.917423911558007, -11.966127044700205, -12.019398637656673, -12.076653000731472, -12.137304444228654, -12.200767278452274, -12.266455813706386, -12.333784360295043, -12.402167228522298, -12.47101872869221, -12.539753171108822, -12.607784866076203, -12.674528123898398, -12.73939725487946, -12.80181165445592, -12.861484517227838, -12.918578040302485, -12.973292307782726, -13.02582740377143, -13.076383412371463, -13.12516041768569, -13.172358503816978, -13.218177754868199, -13.262818254942216, -13.306480088141898, -13.34936333857011, -13.391668090329722, -13.4335944275236, -13.47534243425461, -13.517112194625623, -13.5591037927395, -13.601517312699112, -13.644552838607328, -13.688410454567013, -13.733290244681033, -13.779392293052254, -13.826862560344047, -13.875603332500313, -13.92544834949756, -13.976231347580992, -14.027786062995814, -14.079946231987236, -14.132545590800465, -14.185417875680704, -14.238396822873167, -14.291316168623052, -14.344009649175574, -14.396311000775933, -14.448053959669338, -14.4990858132299, -14.549308104109068, -14.59863595147996, -14.646984474515687, -14.69426879238936, -14.740404024274095, -14.785305289343002, -14.828887706769198, -14.871066395725792, -14.9117564753859, -14.950873064922636, -14.988331283509106, -15.024083837427703, -15.058708189723077, -15.093296765052134, -15.128957358703538, -15.166797765965955, -15.207925782128045, -15.25338889891348, -15.303291592436635, -15.356991010088866, -15.413823797913425, -15.473126601953572, -15.53423606825256, -15.596488842853644, -15.659221571800083, -15.721770901135129, -15.783473479347865, -15.843781918381922, -15.902574816624176, -15.959828563496519, -16.01551954842082, -16.069624160818964, -16.122118790112832, -16.17297982572431, -16.22218365707526, -16.269706673587578, -16.315525264683142, -16.359615819783826, -16.40195472831152, -16.44251837968809, -16.481283163335426, -16.518225468675407, -16.55332168512992, -16.586548202120827, -16.617881409070016, -16.64729769539938, -16.674773763962797, -16.70043326044743, -16.724780561736285, -16.74838089882115, -16.771799502693824, -16.79560160434609, -16.82035243476974, -16.846617224956578, -16.87496120589838, -16.90594960858695, -16.940147664014074, -16.978120603171543, -17.020433657051143, -17.067652056644675, -17.120340867511455, -17.178764338575956, -17.242264036196158, -17.310005214662574, -17.38115312826569, -17.454873031296035, -17.53033017804409, -17.606689822800373, -17.683117219855372, -17.758777623499597, -17.832836288023554, -17.904458467717742, -17.97280941687266, -18.03708227927966, -18.09706801877442, -18.153132135968622, -18.205663362017248, -18.255050428075297, -18.301682065297747, -18.345947004839594, -18.388233977855837, -18.428931715501456, -18.468428948931443, -18.507114409300797, -18.545376827764493, -18.58360493547754, -18.62218746359492, -18.661513143271616, -18.70197070566263, -18.743948881922947, -18.7878362263459, -18.833875677561633, -18.881901075466384, -18.93167494781027, -18.98295982234339, -19.035518226815853, -19.08911268897778, -19.143505736579275, -19.198459897370448, -19.253737699101404, -19.309101669522256, -19.36431433638312, -19.419138227434097, -19.473335870425302, -19.52666979310684, -19.57890252322882, -19.62979658854136, -19.67911476974321, -19.72672421907941, -19.772756902745027, -19.8173861574459, -19.860785319887885, -19.903127726776834, -19.944586714818595, -19.985335620719013, -20.025547781183942, -20.065396532919237, -20.105055212630745, -20.144697157024314, -20.184495702805794, -20.224624186681034, -20.265255945355893, -20.30656431553621, -20.348721934328463, -20.39180957599047, -20.43572558698168, -20.48034678232446, -20.525549977041166, -20.571211986154154, -20.61720962468579, -20.66341970765842, -20.709719050094417, -20.755984467016138, -20.80209277344594, -20.847920784406178, -20.89334531491921, -20.9382431800074, -20.982491194693115, -21.025966173998697, -21.06854493294652, -21.11010428655893, -21.150536690348854, -21.189834561458486, -21.228029659717254, -21.26515383950958, -21.301238955219887, -21.336316861232614, -21.370419411932183, -21.40357846170302, -21.43582586492955, -21.467193475996208, -21.497713149287417, -21.527416739187608, -21.556336100081204, -21.584520267329086, -21.612131040091334, -21.639375687187233, -21.66646160317354, -21.693596182607028, -21.72098682004447, -21.748840910042627, -21.777365847158276, -21.80676902594818, -21.837257840969112, -21.869039686777842, -21.90232126064303, -21.93720996089554, -21.97361173188005, -22.01140812486381, -22.050480691114064, -22.09071098189807, -22.131980548483075, -22.174170942136325, -22.21716371412507, -22.26084041571656, -22.30508259817805, -22.349771812776783, -22.394789610780013, -22.44001754345498, -22.485337162068948, -22.530630017889155, -22.57577766218285, -22.62066164621729, -22.66516352125972, -22.709178020628446, -22.7526864035144, -22.7957048218702, -22.83824952418436, -22.88033675894539, -22.921982774641805, -22.963203819762114, -23.004016142794836, -23.04443599222848, -23.084479616551558, -23.124163264252587, -23.163503183820072, -23.202515623742535, -23.24121683250848, -23.279623058606425, -23.317750550524888, -23.355615556752362, -23.39323432577738, -23.430623106088447, -23.467798146174083, -23.504775694522788, -23.54157199962308, -23.578203309963474, -23.61468587403249, -23.65103594031862, -23.687269757310396, -23.72340357349632, -23.75945363736491, -23.795436197404676, -23.831367502104136, -23.867263799951797, -23.90314133943617, -23.939016369045778, -23.974905137269122, -24.01082389259472, -24.046788883511084, -24.082816358506722, -24.11892256607016, -24.1551237546899, -24.19143617285446, -24.22787606905235, -24.26445969177208, -24.301203289502165, -24.33812311073112, -24.375235403947457, -24.41255641763969, -24.450102400296323, -24.487952406197387, -24.526446454383198, -24.565992334181164, -24.606997835051732, -24.649870746455356, -24.695018857852485, -24.742849958703577, -24.79377183846907, -24.84819228660942, -24.906519092585075, -24.969160045856498, -25.03652293588413, -25.10901555212842, -25.187045684049814, -25.27089210574115, -25.357817853727976, -25.442043099448124, -25.517653573331323, -25.578735005807314, -25.619373127305824, -25.633653668256592, -25.61566235908935, -25.559485073313223, -25.463805865267847, -25.34399614283727, -25.219211677656823, -25.108608241361853, -25.031341605587716, -25.006566614385033, -25.043466701968953, -25.11662039985326, -25.193104379580227, -25.23999531269214, -25.22437739954052, -25.13378191367513, -25.02071340127409, -24.94264516231709, -24.907831393514396, -24.905620088449385, -24.92532009647663, -24.956240266950715, -24.98768944922623, -25.008990689661424, -25.013088405465297, -25.001330037709877, -24.976251860842453, -24.940390149310318, -24.896281177560773, -24.846461220041114, -24.793466]
    cyaw =[-1.0620848795944526, -1.057249217972879, -1.0433461277923848, -1.022018117002673, -0.9955169175782643, -0.9661978657410795, -0.936117298924743, -0.9068214553413247, -0.8793143425056227, -0.8541375204246948, -0.8342187872999459, -0.8379822297063121, -0.870768601613892, -0.9547485492884875, -1.1894455297594164, -2.097536847124425, 3.1332254957951804, -2.959117767712757, -1.5871356323662307, -1.3523797909785464, -1.5769327993249593, -2.855410668211601, 2.969903881936831, 2.969878858167823, 3.035768604899168, 3.1054311098888747, -3.092322789379169, -2.9649617328490594, -2.716391071709177, -2.1182893331461528, -1.3303037167493548, -0.9163841176316051, -0.7321289570928192, -0.6367142816378671, -0.5810635968463935, -0.5463663066099462, -0.5242621392201025, -0.5106350647829674, -0.5033737513345071, -0.501471567229568, -0.5046632519939036, -0.513335071019763, -0.5283644261765873, -0.5377265337497944, -0.5322306491332893, -0.5087373200251477, -0.46372457648651094, -0.39367140213108676, -0.29612023684077016, -0.1716617561299484, -0.026228151411886776, 0.12846137029940513, 0.2595968189033328, 0.3109894813333541, 0.2913960728697198, 0.19990515833466704, 0.024907841736877108, -0.173865303681525, -0.3383702993252842, -0.4647175770226455, -0.5560395449253637, -0.6172957342154575, -0.6525674789420144, -0.6641047603580681, -0.6568861027870108, -0.6479094702849858, -0.6388149892908536, -0.6296723351202548, -0.6205560039664121, -0.6115435003038984, -0.6027132721657166, -0.5941425031788596, -0.5859048887215734, -0.5780703807809817, -0.5710751707894067, -0.5652041471108702, -0.5604374183300854, -0.5567572251586492, -0.5541480114922446, -0.5525964609127663, -0.5520915034656776, -0.552624296394131, -0.554188181446502, -0.5567786203930815, -0.5605721287666053, -0.5663363613004067, -0.5741658982432352, -0.5840748021154679, -0.5960831698413086, -0.6102159482861736, -0.6265014580436856, -0.6449695787101694, -0.6656495488309491, -0.6885673401519513, -0.7137425811978507, -0.7411850321794323, -0.7708906541985624, -0.8028373719878573, -0.836980700098931, -0.8732494830723744, -0.9115420814089061, -0.951349391182151, -0.9829125845879153, -1.0022136897496925, -1.009476960984058, -1.0047582699915747, -0.9879144479839097, -0.9586178610112127, -0.916422296731278, -0.8608958329793114, -0.7918387051846031, -0.7149776734251689, -0.6485542666948804, -0.5942401065559373, -0.5519074643689597, -0.5212051490538269, -0.5017370779581747, -0.4931773673124556, -0.4953334396715192, -0.5081693417041117, -0.531796211066725, -0.5661821414147925, -0.6018376458756706, -0.6337011978439362, -0.6616743398245183, -0.6857016151943838, -0.7057583831544358, -0.7218397389338713, -0.733951049287503, -0.7421003358067519, -0.7462925633518221, -0.7465258052866461, -0.7427892397468518, -0.7350629590089938, -0.7233196255291843, -0.7075280626808421, -0.6876589039475375, -0.6636924164786154, -0.6356285346462104, -0.6061468992515117, -0.580363801246971, -0.5584348656846593, -0.5403650119235351, -0.5261419047407405, -0.5157440612192168, -0.5091471561334883, -0.5063285293517567, -0.5072699632044891, -0.5119588107008662, -0.5203875378582088, -0.5325517140865873, -0.5484464605050113, -0.5680613633141662, -0.5913738937150252, -0.6183414622747541, -0.6488923854201236, -0.6770191309335837, -0.6928285032826602, -0.6963141055181625, -0.6874645950322497, -0.6660824501821636, -0.6318183054009208, -0.584266327574309, -0.5231369459609688, -0.448517734075627, -0.36369913924274877, -0.3096583347450661, -0.29938709331234076, -0.3319888771795439, -0.3912684404687975, -0.44195044487818913, -0.48283679546633496, -0.5141248531084754, -0.536051248610798, -0.5488098559643025, -0.5524988602172312, -0.5470907488511813, -0.5324210786781373, -0.50819551846823, -0.47401902761443077, -0.4294553979584063, -0.37412831305636973, -0.30787332601038025, -0.23093828092307403, -0.15322633564661098, -0.09010641694643719, -0.04177507714301002, -0.007797336599830474, 0.01238207480535861, 0.01924203267423521, 0.013086751342020218, -0.0059779209070107905, -0.03800726440788065, -0.08312063064410234, -0.14133828872165458, -0.2123507862015378, -0.29524481624450516, -0.38207137110463074, -0.43430106654760486, -0.44817791204677115, -0.42305172954505205, -0.35312186200930445, -0.22698915368139955, -0.046996198235039165, 0.08487865592523955, 0.13692377156891586, 0.11412307805593812, 0.032222392122815836, -0.08761188768400215, -0.2223213680586347, -0.335982380583055, -0.41669946707027344, -0.4940411851527229, -0.6034637986773396, -0.882495227122776, -2.3597793713147026, 3.130580562542094, -3.0189310482107663, -2.3904173262322725, -1.4903767955121687, -1.0612250191238148, -0.8807142986889556, -0.7853430016621752, -0.7252859217131289, -0.6821378269448141, -0.6473821355057918, -0.6160031773273278, -0.583884984325414, -0.5494181018354749, -0.5146917160651265, -0.48093207491017503, -0.4497373505888602, -0.42303757127013103, -0.40297962561505346, -0.39172945807921583, -0.3911995870999089, -0.4027290372280371, -0.4267659123611025, -0.4626315488661037, -0.5084669540736129, -0.5590090557178022, -0.6017428539138043, -0.6363261820011524, -0.6637564321909983, -0.6848513649752127, -0.7002608620532464, -0.710484532021825, -0.7158895829850602, -0.7167264987138882, -0.713141686615446, -0.7051870829209561, -0.6928271167921902, -0.6759436942911966, -0.6543401143158861, -0.6281309257258325, -0.6019962624219193, -0.5774884813367466, -0.554707768937001, -0.533739526180025, -0.5146553287759397, -0.4975141926054635, -0.48236402704002906, -0.4692431686299506, -0.4581819019960855, -0.44920389107150405, -0.442327459993245, -0.43756667753956596, -0.43493221130526943, -0.43443192762176247, -0.43607122080120214, -0.43985306116144157, -0.44577775621905813, -0.45384242429127114, -0.4640401854465888, -0.47635908219471584, -0.49078075231327173, -0.5054590690986355, -0.5182672628297341, -0.5292128043011818, -0.5383074332162375, -0.545562965417836, -0.5509903843324961, -0.5545991359017055, -0.5563966157443542, -0.5563878383294689, -0.5545752802039584, -0.5509588923295778, -0.545536279917177, -0.538303051424469, -0.5296956941317331, -0.5201533007029093, -0.5096736878774397, -0.498255315868646, -0.48589756617420826, -0.4726010448145519, -0.45836790925698934, -0.44320221619399786, -0.4271102861034828, -0.41010107910123755, -0.39218657503675264, -0.3733821491408999, -0.3558974504946386, -0.34960789449223556, -0.35569284800848056, -0.3742394919974079, -0.40542798743432923, -0.44944585158856404, -0.5028088824879128, -0.5502106134474543, -0.5897580603155995, -0.621438243504433, -0.6453316586739655, -0.6615535789335346, -0.6702115663911873, -0.6713782595957024, -0.6650776821756897, -0.6512866849983876, -0.6338047518822055, -0.6160668502684101, -0.5980768261345601, -0.5798392782606588, -0.5613595829780941, -0.5426439150411921, -0.5236992640365981, -0.5045334457570346, -0.4851551079909778, -0.4655737302196056, -0.4457996167675354, -0.4258438830248112, -0.40571843444380085, -0.38543593811533655, -0.36500978684201185, -0.34445405575075017, -0.3237834516189607, -0.30301325522527084, -0.2821592571732866, -0.26130695763104667, -0.24443160810663828, -0.23373980283051726, -0.2291455614416885, -0.23062619614554034, -0.23822712299918095, -0.25206170337434436, -0.2723057074542391, -0.2991850010333407, -0.33295409922289326, -0.3738625092006253, -0.4221057429609141, -0.47775928533442963, -0.54069764253536, -0.6104401138060828, -0.6764822334369057, -0.7315128126715568, -0.7756829471542658, -0.8093483439262821, -0.8329164942395058, -0.8467447031271526, -0.851079526416653, -0.8460266691858922, -0.8315436423409023, -0.8074522801299157, -0.7734731775373707, -0.7292884106569201, -0.6765833905422649, -0.6263975222649344, -0.5807683168011805, -0.5399057227640038, -0.5039129834111944, -0.4728129943938966, -0.44657384831414304, -0.4251313720799046, -0.4084076617625, -0.3963254433864391, -0.3888185477221305, -0.3858389650200805, -0.387360935898784, -0.39338241537467356, -0.4039240740404883, -0.4190258119883493, -0.43874058748191364, -0.4630731853955121, -0.4876201205937293, -0.5094988701927043, -0.5286711136193887, -0.54511334929324, -0.5588128017950026, -0.5697637887657219, -0.5779646403875207, -0.5834152190017393, -0.5861150573274951, -0.586062118460677, -0.5832521761261715, -0.5776788160254994, -0.5693340650477305, -0.5582096610693528, -0.5442989784324884, -0.5275996191328775, -0.5081734078351893, -0.48902962627397023, -0.47187822174983624, -0.45672465889041086, -0.4435686889119161, -0.43240616798737525, -0.42323063620594625, -0.41603464645286087, -0.41081084252789085, -0.4075527916872542, -0.40625557934077633, -0.40691617368139243, -0.4095335663391589, -0.4141086924411467, -0.42064413036890913, -0.4291435786524267, -0.4395137496470567, -0.4494825822815653, -0.4580914879810664, -0.4653385989402373, -0.4712229695181324, -0.4757441734885774, -0.47890197622139913, -0.4806960824809428, -0.4811259600081717, -0.48019073888568553, -0.4778891867656333, -0.47421976026276963, -0.46918073307277713, -0.4627704015623196, -0.4549873685828237, -0.445830905972482, -0.4353013955162873, -0.42340084691903046, -0.41075558520169064, -0.398465170055286, -0.3865516971540332, -0.37501606902058376, -0.36385870768314094, -0.35307960426930096, -0.34267836740660584, -0.33265427015170135, -0.3230062952267176, -0.3137331783934455, -0.30483344984281124, -0.2963054735189301, -0.28814748433361487, -0.2810198415816161, -0.2761185195461628, -0.2734628149233523, -0.273051352302067, -0.27488748407983504, -0.2789793779365053, -0.2853397867807208, -0.29398548899346527, -0.3049363776650913, -0.3182141702167806, -0.3338407057733448, -0.3517331098188472, -0.36934790587770033, -0.3855513104221869, -0.4003100772828951, -0.41359865518314076, -0.4253984343840589, -0.43569698518054417, -0.44448732020545884, -0.4517672059373716, -0.4575385425011685, -0.4618068251106057, -0.4645806954890549, -0.46587158736382145, -0.46569346662016037, -0.46406266382875955, -0.4609977945022016, -0.45651976046164405, -0.4506518239833751, -0.44341974484529895, -0.43547804725349604, -0.4279667204092136, -0.4208940835851289, -0.41424579848700666, -0.4080086470406061, -0.40217049096119084, -0.3967202340258593, -0.3916477873301537, -0.38694403774891395, -0.3826008197757946, -0.37861089088375993, -0.37496791052808165, -0.37166642290220864, -0.3687018435540135, -0.36607044997426463, -0.36376937627996125, -0.3617966121317897, -0.36015100604705846, -0.35883227329682166, -0.35784100860845297, -0.35717870393277534, -0.35684777157818454, -0.35685157306336684, -0.3571944540956285, -0.35788178614407573, -0.35892001514652594, -0.36031671796680503, -0.36208066730575367, -0.3642219058656136, -0.3667518306742945, -0.3696832885940179, -0.37303068416857155, -0.376810101105143, -0.3810394388401994, -0.3857385658032526, -0.3909294911654598, -0.396636557038255, -0.4028866532644993, -0.4097094571115742, -0.41713770031829844, -0.4252074660446039, -0.43395851829446463, -0.4434346662855713, -0.45368416596294714, -0.46476016031332945, -0.47672115921517705, -0.48963155809458403, -0.5032115266539233, -0.5168227378734661, -0.5300127167864287, -0.5423627868622284, -0.5535310491107235, -0.5632800358754602, -0.5714852792247127, -0.5781266914747316, -0.5832683899222223, -0.5870336069286138, -0.5895801858166938, -0.5910800611774927, -0.5917040818310361, -0.5916120820405502, -0.5898119035997058, -0.5796355670063617, -0.5587111570361036, -0.5220581455630158, -0.45665942983361113, -0.32487351251091995, 0.015177726354574587, 0.9831410543980746, 1.7660557231502452, 1.9811834925350766, 2.0424693575555417, 2.0479449010872863, 1.9938726152533073, 1.712191526650111, -0.16973925068733015, -0.5787212012933064, -0.6126901587990461, -0.5467394733689425, -0.25505997027913524, 1.141370799229987, 1.6598892317971181, 1.5306311871660636, 0.8589937083086358, 0.2016195883705432, -0.0975703935743571, -0.21471761128403521, -0.2448804564445523, -0.21227186267087086, -0.10640698220542687, 0.03903994266567826, 0.18720454353164395, 0.3231577719019967, 0.4338305469109458, 0.511581488862921]

    return cx, cy, cyaw

#--------------------------------------------------------------------------------------------------------------
def pid_control(target, current):
    """
    Proportional control for the speed.

    :param target: (float)
    :param current: (float)
    :return: (float)
    """
    return Kp * (target - current)

def stanley_control(state, cx, cy, cyaw, last_target_idx):
    """
    Stanley steering control.

    :param state: (State object)
    :param cx: ([float])
    :param cy: ([float])
    :param cyaw: ([float])
    :param last_target_idx: (int)
    :return: (float, int)
    """
    #recall that the output to state includes x,y, yaw
    current_target_idx, error_front_axle = calc_target_index(state, cx, cy)

    if last_target_idx >= current_target_idx:
        current_target_idx = last_target_idx

    # theta_e corrects the heading error
    theta_e = normalize_angle(cyaw[current_target_idx] - state.yaw)
    # theta_d corrects the cross track error
    theta_d = np.arctan2(k * error_front_axle, state.v)
    # Steering control
    delta = theta_e + theta_d

    return delta, current_target_idx

def normalize_angle(angle):
    """
    Normalize an angle to [-pi, pi].

    :param angle: (float)
    :return: (float) Angle in radian in [-pi, pi]
    """
    while angle > np.pi:
        angle -= 2.0 * np.pi

    while angle < -np.pi:
        angle += 2.0 * np.pi

    return angle


def calc_target_index(state, cx, cy):
    """
    Compute index in the trajectory list of the target.

    :param state: (State object)
    :param cx: [float]
    :param cy: [float]
    :return: (int, float)
    """
    L=1.22#(meters)
    # Calc front axle position
    fx = state.x + L * np.cos(state.yaw)
    fy = state.y + L * np.sin(state.yaw)

    # Search nearest point index
    dx = [fx - icx for icx in cx]
    dy = [fy - icy for icy in cy]
    d = np.hypot(dx, dy)
    target_idx = np.argmin(d)

    # Project RMS error onto front axle vector
    front_axle_vec = [-np.cos(state.yaw + np.pi / 2),
                      -np.sin(state.yaw + np.pi / 2)]
    error_front_axle = np.dot([dx[target_idx], dy[target_idx]], front_axle_vec)

    return target_idx, error_front_axle


class Controller_node(Node):

    def __init__(self):
        super().__init__('controller_node') 
        self.k = 0.5  # control gain
        self.Kp = 1.0  # speed proportional gain
        self.dt = 0.1  # [s] time difference
        self.L = 2.9  # [m] Wheel base of vehicle
        self.max_steer = np.radians(30.0)  # [rad] max steering angle
        self.last_target_idx = 0  # To track the last target index
        self.cx = [1.0, 2.0, 3.0]  # Example list of x-coordinates of waypoints
        self.cy = [1.0, 2.0, 3.0]  # Example list of y-coordinates of waypoints
        self.cyaw = [0.0, 1.0, 2.0]  # Example list of yaw values of waypoints
        self.state = [0, 0, 0, 0]  # Initial state: x, y, yaw, velocity
        self.wheel_angle=0
          
        self.publisher_ = self.create_publisher(Twist, 'cmd_vel', 10)
        self.create_subscription(Odometry, 'odom', self.odometry_callback, 10)

    def odometry_callback(self, msg):
        x = msg.pose.pose.position.x
        y = msg.pose.pose.position.y
        yaw = msg.twist.twist.angular.z
        v = msg.twist.twist.linear.x
        cx,cy,cyaw = reference_data()

        self.state = [x, y, yaw, v]

        self.wheel_angle,self.last_target_idx = self.stanley_control(self.state, self.cx, self.cy, self.cyaw, self.last_target_idx)
        self.last_target_idx = wheel_angle  # Ensure you update the last target index here

        # Publish control command using wheel_angle
        self.publish_wheel_angle(wheel_angle)

    def stanley_control(state, cx, cy, cyaw, last_target_idx):
        """
        Stanley steering control.

        :param state: (State object)
        :param cx: ([float])
        :param cy: ([float])
        :param cyaw: ([float])
        :param last_target_idx: (int)
        :return: (float, int)
        """
        #recall that the output to state includes x,y, yaw
        current_target_idx, error_front_axle = calc_target_index(state, cx, cy)

        if last_target_idx >= current_target_idx:
            current_target_idx = last_target_idx

        # theta_e corrects the heading error
        theta_e = normalize_angle(cyaw[current_target_idx] - state.yaw)
        # theta_d corrects the cross track error
        theta_d = np.arctan2(k * error_front_axle, state.v)
        # Steering control
        delta = theta_e + theta_d

        return delta, current_target_idx

    def publish_wheel_angle(self, wheel_angle):
        msg = Twist()
        # Set your control command, e.g., wheel angle, in the Twist message
        msg.angular.z= wheel_angle
        self.publisher_.publish(msg)

def main():
    rclpy.init()
    node = Controller_node()
    rclpy.spin(node)
    rclpy.shutdown()

if __name__ == '__main__':
    main()